<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="CTF, Sec, 安全" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Stop Here">
<meta property="og:url" content="http://www.leommxj.com/index.html">
<meta property="og:site_name" content="Stop Here">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Stop Here">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Stop Here </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?506d4068ac30a997f544c02d629de531";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Stop Here</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">And FxxkOff</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/02/21/write-a-ida-process-module-for-chip-8/" itemprop="url">
                  为CHIP-8编写ida process module
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-02-21T02:23:33+08:00" content="2019-02-21">
              2019-02-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Sec/" itemprop="url" rel="index">
                    <span itemprop="name">Sec</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在对嵌入式设备进行逆向分析的过程中，偶尔会遇到一些比较小众或专业性较强的处理器，使用ida默认不支持的指令集。这时为了愉快的使用ida pro逆向就需要编写对应的处理器模块。出于学习目的，找一个非常简单的指令集来探路，CHIP-8再合适不过了。</p>
<h2 id="CHIP-8简介"><a href="#CHIP-8简介" class="headerlink" title="CHIP-8简介"></a>CHIP-8简介</h2><p>CHIP-8是一种解释型编程语言，出现在上世纪七十年代中期，被用来开发电子游戏以及图形化计算器等。CHIP-8的代码运行在CHIP-8虚拟机上。</p>
<ul>
<li>多数时候其解释器需要占据内存空间的前512个字节，所以程序通常加载在0x200处，且不会用到前512字节地址。</li>
<li>CHIP-8使用16个8bit的数据寄存器，命名为V0-VF。其中VF寄存器在执行某些指令时作为状态寄存器。有一个16位的地址寄存器I。</li>
<li>CHIP-8有两个定时器，延时寄存器(Delay timer)与声音寄存器(Sound timer)。</li>
<li>唯一使用栈的地方是call的时候存储返回地址<br>其他信息可以在wikipedia上了解:<a href="https://en.wikipedia.org/wiki/CHIP-8" target="_blank" rel="external">https://en.wikipedia.org/wiki/CHIP-8</a></li>
</ul>
<h2 id="初探ida处理器模块-IDA-Pro-7-0"><a href="#初探ida处理器模块-IDA-Pro-7-0" class="headerlink" title="初探ida处理器模块(IDA Pro 7.0)"></a>初探ida处理器模块(IDA Pro 7.0)</h2><p>ida处理器模块的样例可以在sdk中modules目录下找到，一打开目录映入眼帘的就是许多的c++写的处理器模块。在module/script下有三个python的处理器模块，包含一个<code>proctemplate.py</code>模板。这里选择使用python编写，在模板文件中可以看到主要代码为PROCESSOR_ENTRY方法返回一个继承自processor_t的sample_proccess<em>t,类中有许多的`notify</em><code>开头的回调方法，每个都有少量对其应该负责的工作的注释。 通过注释可以知道其中</code>notify_emu<code>`notify_out_operand</code> <code>notify_out_insn</code> <code>notify_ana</code>几个方法是强制性的。</p>
<h3 id="IDA指令解析流程"><a href="#IDA指令解析流程" class="headerlink" title="IDA指令解析流程"></a>IDA指令解析流程</h3><h4 id="分析-Ana"><a href="#分析-Ana" class="headerlink" title="分析(Ana)"></a>分析(Ana)</h4><p>在<code>notify_ana(self, insn)</code>中，需要做的是读取数据并解析成指令。根据opcode找到对应的指令，读取并设置好指令的参数与属性。其中insn为一个insn_t类型的变量，即为要设置的指令对象。调用insn.get_next_byte()系列方法可以获取到当前的数据，也就是下一步要解析的指令或操作数。设置insn的itype属性为指令的itype,根据操作数数量设置<code>insn.Op1</code>及<code>insn.Op2</code>的系列属性如type(操作数类型):o_imm(立即数)/o_reg(寄存器)/o_mem(内存)……、dtype(操作数大小):dt_byte/dt_word/dt_dword和value(操作数的值)。</p>
<h4 id="模拟-Emu"><a href="#模拟-Emu" class="headerlink" title="模拟(Emu)"></a>模拟(Emu)</h4><p>体现在<code>notify_emu(self)</code>中，用于设置数据与代码之间的关系，例如当前指令执行完毕后如果顺序执行下一条指令就要通过<code>add_cref(insn.ea, insn.ea + insn.size, fl_F)</code>来告诉ida这条指令的下一条在哪。其中第一个参数为出发点，多数时候为当前指令地址，第二个参数为将跳到的地址，第三个参数有可能为 fl_F(顺序),fl_JN/fl_JF(跳转)以及fl_CN/fl_CF(调用)。以及使用<code>add_dref(op.addr, op.offb, dr_O)</code>类似指令来添加数据的引用信息。<br>如果有对栈数据的分析也在模拟过程中处理，可参考ebc.py中emu回调所调用的<code>trace_sp</code>方法。再笔者的理解中，除了个别情况，大多数修改ida数据库中数据的操作都在模拟部分进行。</p>
<h4 id="输出-output"><a href="#输出-output" class="headerlink" title="输出(output)"></a>输出(output)</h4><p>体现在<code>notify_out_operand(self, ctx, op)</code>与<code>notify_out_insn(self, ctx)</code>两个方法。notify_out_operand用来输出参数，notify_out_insn用来输出指令。注释中特意指出在这两个方法中不应该有任何操作数据库，修改标志位等操作。笔者认为与output操作执行次数较多有关。</p>
<h3 id="看一看script-dll"><a href="#看一看script-dll" class="headerlink" title="看一看script.dll"></a>看一看<code>script.dll</code></h3><p>在ida的procs目录下可以看到<code>script.dll</code>与<code>script64.dll</code>两个文件，其与我们使用python编写处理器模块密切相关。用ida打开script.dll，字符串中可以看到许多在<code>proctemplate.py</code>模板中出现过的熟悉的方法名。<br>初始化过程中sub_130021F0=&gt;sub_13005B30=&gt;sub_13006100会寻找PROCESSOR_ENTRY方法并尝试接收其返回的对象<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> __<span class="function">fastcall <span class="title">sub_13006100</span><span class="params">(__int64 a1, __int64 a2, _BYTE *a3, __int64 a4)</span></span></div><div class="line">&#123;</div><div class="line">  _QWORD *v4; <span class="comment">// rbx</span></div><div class="line">  _BYTE *v5; <span class="comment">// rsi</span></div><div class="line">  <span class="keyword">unsigned</span> __int8 (__fastcall *v6)(_BYTE *, __int64, _QWORD *); <span class="comment">// r9</span></div><div class="line">  __int64 v7; <span class="comment">// rdi</span></div><div class="line"></div><div class="line">  v4 = (_QWORD *)a4;</div><div class="line">  v5 = a3;</div><div class="line">  v6 = *(<span class="keyword">unsigned</span> __int8 (__fastcall **)(_BYTE *, __int64, _QWORD *))(a1 + <span class="number">112</span>);</div><div class="line">  v7 = a1;</div><div class="line">  <span class="keyword">if</span> ( v6 )</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span> ( !v6(a3, a2, v4) )</div><div class="line">      <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span> ( !(*(<span class="keyword">unsigned</span> __int8 (__fastcall **)(__int64, _QWORD *))(a1 + <span class="number">48</span>))(a2, v4) )</div><div class="line">      <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> ( !(*(<span class="keyword">unsigned</span> __int8 (__fastcall **)(_QWORD, _QWORD, <span class="keyword">const</span> <span class="keyword">char</span> *))(v7 + <span class="number">88</span>))(<span class="number">0</span>i64, <span class="number">0</span>i64, <span class="string">"PROCESSOR_ENTRY"</span>) )</div><div class="line">    &#123;</div><div class="line">      sub_13003EA0(v4, <span class="string">"PROCESSOR_ENTRY attribute was not found"</span>);</div><div class="line">      <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ( !(*(<span class="keyword">unsigned</span> __int8 (__fastcall **)(_BYTE *, <span class="keyword">const</span> <span class="keyword">char</span> *, _QWORD, _QWORD, _QWORD *))(v7 + <span class="number">56</span>))(</div><div class="line">            v5,</div><div class="line">            <span class="string">"PROCESSOR_ENTRY"</span>,</div><div class="line">            <span class="number">0</span>i64,</div><div class="line">            <span class="number">0</span>i64,</div><div class="line">            v4) )</div><div class="line">      <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ( *v5 == <span class="number">5</span> )</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  sub_13003EA0(v4, <span class="string">"should return an object!"</span>);</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>成功后在sub_13003F70中检查前文提到的几个强制性的回调函数是否存在<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">do</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int8)sub_13005FD0(off_1300ABE8[v2], &amp;unk_1300F150) )</div><div class="line">  &#123;</div><div class="line">    sub_13005260(v1, <span class="string">"Processor module script: missing callback '%s'"</span>, off_1300ABE8[v2]);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line">  ++v2;</div><div class="line">&#125;</div><div class="line"><span class="keyword">while</span> ( v2 &lt; <span class="number">4</span> );</div></pre></td></tr></table></figure></p>
<p>随后会在sub_13004C90中解析几个处理器属性，可以注意到<code>assembler</code>与<code>instruc</code>，也是一会必须要编写好的属性。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">__int64 __<span class="function">fastcall <span class="title">sub_13004C90</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, __int64 a4)</span></span></div><div class="line">&#123;</div><div class="line">  __int64 v4; <span class="comment">// rbx</span></div><div class="line">  <span class="keyword">unsigned</span> __int8 v5; <span class="comment">// si</span></div><div class="line">  <span class="keyword">int</span> v6; <span class="comment">// eax</span></div><div class="line">  __int64 v7; <span class="comment">// rdx</span></div><div class="line">  __int64 v8; <span class="comment">// r8</span></div><div class="line">  <span class="keyword">size_t</span> v9; <span class="comment">// rbx</span></div><div class="line">  <span class="keyword">unsigned</span> __int64 v10; <span class="comment">// rdi</span></div><div class="line">  __int64 v11; <span class="comment">// rax</span></div><div class="line">  <span class="keyword">char</span> *v12; <span class="comment">// rax</span></div><div class="line">  <span class="keyword">char</span> *v13; <span class="comment">// rcx</span></div><div class="line">  __int64 v14; <span class="comment">// r8</span></div><div class="line">  __int64 v15; <span class="comment">// r8</span></div><div class="line">  __int64 v16; <span class="comment">// r8</span></div><div class="line">  <span class="keyword">char</span> v18; <span class="comment">// [rsp+20h] [rbp-448h]</span></div><div class="line">  <span class="keyword">int</span> v19; <span class="comment">// [rsp+28h] [rbp-440h]</span></div><div class="line">  __int64 v20; <span class="comment">// [rsp+40h] [rbp-428h]</span></div><div class="line">  <span class="keyword">char</span> Src[<span class="number">1024</span>]; <span class="comment">// [rsp+50h] [rbp-418h]</span></div><div class="line"></div><div class="line">  v20 = <span class="number">-2</span>i64;</div><div class="line">  v4 = a1;</div><div class="line">  qword_1300F478 = (__int64)off_1300A800;</div><div class="line">  v5 = <span class="number">0</span>;</div><div class="line">  v18 = <span class="number">2</span>;</div><div class="line">  v19 = <span class="number">0</span>;</div><div class="line">  LOBYTE(a4) = <span class="number">1</span>;</div><div class="line">  v6 = sub_13005B80(off_1300A800, &amp;xmmword_1300F250, a1, a4, *(_QWORD *)&amp;v18, *(_QWORD *)&amp;v19);</div><div class="line">  <span class="keyword">if</span> ( v6 &lt; <span class="number">0</span> )</div><div class="line">  &#123;</div><div class="line">    LODWORD(xmmword_1300F250) = <span class="number">700</span>;</div><div class="line">    <span class="keyword">if</span> ( !(_DWORD)xmmword_1300F290 )</div><div class="line">      LODWORD(xmmword_1300F290) = sub_130061E0(*((_QWORD **)&amp;xmmword_1300F280 + <span class="number">1</span>));</div><div class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)sub_13006A20(v4, (__int64)<span class="string">"assembler"</span>, (__int64)&amp;v18) &amp;&amp; (<span class="keyword">unsigned</span> __int8)sub_13004A90(&amp;v18) )</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)sub_13006A20(v4, (__int64)<span class="string">"codestart"</span>, (__int64)&amp;v18)</div><div class="line">        &amp;&amp; (LOBYTE(v14) = <span class="number">1</span>, (<span class="keyword">unsigned</span> __int8)sub_13006200(&amp;v18, &amp;qword_1300F4D0, v14)) )</div><div class="line">      &#123;</div><div class="line">        *((_QWORD *)&amp;xmmword_1300F2A0 + <span class="number">1</span>) = qword_1300F4D0;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span></div><div class="line">      &#123;</div><div class="line">        *((_QWORD *)&amp;xmmword_1300F2A0 + <span class="number">1</span>) = <span class="number">0</span>i64;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)sub_13006A20(v4, (__int64)<span class="string">"retcodes"</span>, (__int64)&amp;v18)</div><div class="line">        &amp;&amp; (LOBYTE(v15) = <span class="number">1</span>, (<span class="keyword">unsigned</span> __int8)sub_13006200(&amp;v18, &amp;qword_1300F4B8, v15)) )</div><div class="line">      &#123;</div><div class="line">        *(_QWORD *)&amp;xmmword_1300F2B0 = qword_1300F4B8;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span></div><div class="line">      &#123;</div><div class="line">        *(_QWORD *)&amp;xmmword_1300F2B0 = <span class="number">0</span>i64;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)sub_13006A20(v4, (__int64)<span class="string">"instruc"</span>, (__int64)&amp;v18)</div><div class="line">        &amp;&amp; (<span class="keyword">unsigned</span> __int8)sub_130063C0((__int64)&amp;v18, &amp;qword_1300F488, v16) )</div><div class="line">      &#123;</div><div class="line">        *(_QWORD *)&amp;xmmword_1300F2C0 = qword_1300F488;</div><div class="line">        *(_QWORD *)&amp;xmmword_1300F280 = sub_130021F0;</div><div class="line">        v5 = <span class="number">1</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span></div><div class="line">      &#123;</div><div class="line">        sub_13003EA0(&amp;Dst, <span class="string">"Missing processor instructions definition"</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>最重要的地方是13003b51h处的call，<code>hook_to_notification_point(3i64, sub_130041E0)</code>。查看ida sdk include/idp.hpp可以看到对hook_to_notification_point说明和函数原型：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// Register a callback for a class of events in IDA</span></div><div class="line"></div><div class="line"><span class="function">idaman <span class="keyword">bool</span> ida_export <span class="title">hook_to_notification_point</span><span class="params">(</span></span></div><div class="line">        <span class="keyword">hook_type_t</span> hook_type,</div><div class="line">        <span class="keyword">hook_cb_t</span> *cb,</div><div class="line">        <span class="keyword">void</span> *user_data = <span class="literal">NULL</span>);</div></pre></td></tr></table></figure></p>
<p>hook_type_t枚举体的定义：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> <span class="keyword">hook_type_t</span></div><div class="line">&#123;</div><div class="line">  HT_IDP,         <span class="comment">///&lt; Hook to the processor module.</span></div><div class="line">                  <span class="comment">///&lt; The callback will receive all processor_t::event_t events.</span></div><div class="line">  HT_UI,          <span class="comment">///&lt; Hook to the user interface.</span></div><div class="line">                  <span class="comment">///&lt; The callback will receive all ::ui_notification_t events.</span></div><div class="line">  HT_DBG,         <span class="comment">///&lt; Hook to the debugger.</span></div><div class="line">                  <span class="comment">///&lt; The callback will receive all ::dbg_notification_t events.</span></div><div class="line">  HT_IDB,         <span class="comment">///&lt; Hook to the database events.</span></div><div class="line">                  <span class="comment">///&lt; These events are separated from the ::HT_IDP group</span></div><div class="line">                  <span class="comment">///&lt; to speed things up (there are too many plugins and</span></div><div class="line">                  <span class="comment">///&lt; modules hooking to the ::HT_IDP). Some essential events</span></div><div class="line">                  <span class="comment">///&lt; are still generated in th ::HT_IDP group:</span></div><div class="line">                  <span class="comment">///&lt; make_code, make_data</span></div><div class="line">                  <span class="comment">///&lt; This list is not exhaustive.</span></div><div class="line">                  <span class="comment">///&lt; A common trait of all events in this group: the kernel</span></div><div class="line">                  <span class="comment">///&lt; does not expect any reaction to the event and does not</span></div><div class="line">                  <span class="comment">///&lt; check the return code. For event names, see ::idb_event.</span></div><div class="line">  HT_DEV,         <span class="comment">///&lt; Internal debugger events.</span></div><div class="line">                  <span class="comment">///&lt; Not stable and undocumented for the moment</span></div><div class="line">  HT_VIEW,        <span class="comment">///&lt; Custom/IDA views notifications.</span></div><div class="line">                  <span class="comment">///&lt; Refer to ::view_notification_t</span></div><div class="line">                  <span class="comment">///&lt; for notification codes</span></div><div class="line">  HT_OUTPUT,      <span class="comment">///&lt; Output window notifications.</span></div><div class="line">                  <span class="comment">///&lt; Refer to ::msg_notification_t</span></div><div class="line">                  <span class="comment">///&lt; (::view_notification_t)</span></div><div class="line">  HT_GRAPH,       <span class="comment">///&lt; Handling graph operations</span></div><div class="line">                  <span class="comment">///&lt; (::graph_notification_t)</span></div><div class="line">  HT_LAST</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>第一个参数为3，即HT_IDB,从注释看出make_code, make_data等事件会触发回调。回调函数的原型如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">typedef</span> ssize_t idaapi <span class="title">hook_cb_t</span><span class="params">(<span class="keyword">void</span> *user_data, <span class="keyword">int</span> notification_code, va_list va)</span></span>;</div></pre></td></tr></table></figure></p>
<p>可以看出sub_130041E0的第二个参数即为notification_code，此处为processor_t::event_t。其定义可以在<a href="https://www.hex-rays.com/products/ida/support/sdkdoc/structprocessor__t.html" target="_blank" rel="external">ida文档</a>中找到，也可通过qword_1300E000处得知。<br><img src="http://pic.leommxj.com//blog/write-a-ida-process-module-for-chip-8/notification_code.png" alt="notification_code"><br>函数会根据不同的notification_code调用不同的回调函数。</p>
<h2 id="编写最简单的ida处理器模块"><a href="#编写最简单的ida处理器模块" class="headerlink" title="编写最简单的ida处理器模块"></a>编写最简单的ida处理器模块</h2><h3 id="定义处理器属性"><a href="#定义处理器属性" class="headerlink" title="定义处理器属性"></a>定义处理器属性</h3><p>修改sample_processor_t为chip8_processor_t。首先需要设置一些处理器模块的基本信息。每个处理器模块都需要有id，name。这里直接在模板基础上更改就好，挑一个没人用的id，psnames与plnames为名字缩写与全称。cnbits与dnbits设为8即可，assembler暂时无需更改。flag指定了一些特性，根据需要设置。PTRSZ为指针大小，由于chip8地址空间有0x1000个字节，这里设置为2即16bits。</p>
<h4 id="定义寄存器"><a href="#定义寄存器" class="headerlink" title="定义寄存器"></a>定义寄存器</h4><p>为了代码可读性，学习ebc.py做法，将定义寄存器的代码单独编写为一个方法并在chip8_processor_t的<strong>init</strong>方法中调用。设置好chip8所用的寄存器。由于ida的实现问题，虽然用不到段寄存器，但仍需要设置好假的段寄存器。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_registers</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="comment"># register names</span></div><div class="line">    self.reg_names = [</div><div class="line">        <span class="comment"># General purpose registers</span></div><div class="line">        <span class="string">"V0"</span>,</div><div class="line">        <span class="string">"V1"</span>,</div><div class="line">        <span class="string">"V2"</span>,</div><div class="line">        <span class="string">"V3"</span>,</div><div class="line">        <span class="string">"V4"</span>,</div><div class="line">        <span class="string">"V5"</span>,</div><div class="line">        <span class="string">"V6"</span>,</div><div class="line">        <span class="string">"V7"</span>,</div><div class="line">        <span class="string">"V8"</span>, </div><div class="line">        <span class="string">"V9"</span>,</div><div class="line">        <span class="string">"VA"</span>,</div><div class="line">        <span class="string">"VB"</span>,</div><div class="line">        <span class="string">"VC"</span>,</div><div class="line">        <span class="string">"VD"</span>,</div><div class="line">        <span class="string">"VE"</span>,</div><div class="line">        <span class="string">"VF"</span>,</div><div class="line">        <span class="comment"># </span></div><div class="line">        <span class="string">"PC"</span>,<span class="comment"># Instruction pointer</span></div><div class="line">        <span class="string">"I"</span>, <span class="comment"># Index register 12bit</span></div><div class="line">        <span class="string">"DT"</span>,<span class="comment"># Delay timer</span></div><div class="line">        <span class="string">"ST"</span>,<span class="comment"># Sound timer</span></div><div class="line">        <span class="comment"># Fake segment registers</span></div><div class="line">        <span class="string">"CS"</span>,</div><div class="line">        <span class="string">"DS"</span></div><div class="line">    ]</div><div class="line">    <span class="comment"># number of registers (optional: deduced from the len(reg_names))</span></div><div class="line">    self.regs_num = len(self.reg_names)</div><div class="line">    <span class="comment"># Segment register information (use virtual CS and DS registers if your</span></div><div class="line">    <span class="comment"># processor doesn't have segment registers):</span></div><div class="line">    self.reg_first_sreg = <span class="number">19</span> <span class="comment"># index of CS</span></div><div class="line">    self.reg_last_sreg  = <span class="number">20</span> <span class="comment"># index of DS</span></div><div class="line">    <span class="comment"># size of a segment register in bytes</span></div><div class="line">    self.segreg_size = <span class="number">0</span></div><div class="line">    <span class="comment"># You should define 2 virtual segment registers for CS and DS.</span></div><div class="line">    <span class="comment"># number of CS/DS registers</span></div><div class="line">    self.reg_code_sreg = <span class="number">19</span></div><div class="line">    self.reg_data_sreg = <span class="number">20</span></div></pre></td></tr></table></figure></p>
<h4 id="设置指令集"><a href="#设置指令集" class="headerlink" title="设置指令集"></a>设置指令集</h4><p>在刚才分析script.dll时可以看到ida需要一个instruc属性存放指令信息，同时我们在解析指令时可以查表更加方便。还需要设置chip8_processor_t的itype<em>xx与之对应。这里同样编写一个在<strong>init</strong>中调用的方法，初始化指令表。这里指令对应的助记表示是根据github上<a href="https://github.com/massung/CHIP-8#instruction-set" target="_blank" rel="external">CHIP-8</a>项目的指令集说明。<br>由于指令无法按顺序解析，定义itable时每条指令设置mask与opcode，通过操作数与掩码结合来判断指令，要注意用这种方法定义指令集需要将更精确的匹配项放在前面。idef的d属性为对应指令的解析方法，这里根据操作数类型等编写了几个方法解析并设置操作数信息，方便后面分析过程分析指令。<br>不同指令的文字表达相同，所以不能像ebc.py中将指令名称直接与`”itype</em>“<code>拼接作为属性名称，而是将指令的操作数与</code>“itype_”<code>拼接后作为属性名称。
最后还需要设置指令集表项的起始索引与结束索引</code>self.instruc_start<code>`self.instruc_end</code>，ret指令的itype信息<code>self.icode_return</code>。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_instruction</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">idef</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, opcode, mask, name, cf, d, cmt = None)</span>:</span></div><div class="line">            self.opcode = opcode</div><div class="line">            self.mask = mask</div><div class="line">            self.name = name </div><div class="line">            self.cf = cf</div><div class="line">            self.d = d</div><div class="line">            self.cmt = cmt</div><div class="line">        </div><div class="line">    self.itable = [</div><div class="line">        idef(opcode=<span class="number">0x00E0</span>, mask=<span class="number">0xffff</span>, name=<span class="string">"CLS"</span>,  d=self.decode_OP, cf=<span class="number">0</span>, cmt=<span class="string">"Clear video memory"</span>),</div><div class="line">        idef(opcode=<span class="number">0x00EE</span>, mask=<span class="number">0xffff</span>, name=<span class="string">"RET"</span>,  d=self.decode_OP, cf=CF_STOP, cmt=<span class="string">"Return from subroutine"</span>),</div><div class="line">        idef(opcode=<span class="number">0x0000</span>, mask=<span class="number">0xf000</span>, name=<span class="string">"SYS"</span>,  d=self.decode_NNN_mem, cf=CF_USE1, cmt=<span class="string">"Call CDP1802 subroutine at NNN"</span>),</div><div class="line">        idef(opcode=<span class="number">0x1000</span>, mask=<span class="number">0Xf000</span>, name=<span class="string">"JP"</span>,   d=self.decode_NNN_mem, cf=CF_USE1|CF_JUMP, cmt=<span class="string">"Jump to address NNN"</span>),</div><div class="line">        idef(opcode=<span class="number">0x2000</span>, mask=<span class="number">0xf000</span>, name=<span class="string">"CALL"</span>, d=self.decode_NNN_mem, cf=CF_USE1|CF_CALL, cmt=<span class="string">"Call CHIP-8 subroutine at NNN"</span>),</div><div class="line">        idef(opcode=<span class="number">0x3000</span>, mask=<span class="number">0xf000</span>, name=<span class="string">"SE"</span>,   d=self.decode_XNN, cf=CF_USE1|CF_USE2|CF_JUMP, cmt=<span class="string">"Skip next instruction if VX == NN"</span>),</div><div class="line">        idef(opcode=<span class="number">0x4000</span>, mask=<span class="number">0xf000</span>, name=<span class="string">"SNE"</span>,  d=self.decode_XNN, cf=CF_USE1|CF_USE2|CF_JUMP, cmt=<span class="string">"Skip next instruction if VX != NN"</span>),</div><div class="line">        idef(opcode=<span class="number">0x5000</span>, mask=<span class="number">0xf00f</span>, name=<span class="string">"SE"</span>,   d=self.decode_XY, cf=CF_USE1|CF_USE2|CF_JUMP, cmt=<span class="string">"Skip next instruction if VX == VY"</span>),</div><div class="line">        idef(opcode=<span class="number">0x6000</span>, mask=<span class="number">0xf000</span>, name=<span class="string">"LD"</span>,   d=self.decode_XNN, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VX = NN"</span>),</div><div class="line">        idef(opcode=<span class="number">0x7000</span>, mask=<span class="number">0xf000</span>, name=<span class="string">"ADD"</span>,  d=self.decode_XNN, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VX = VX + NN"</span>),</div><div class="line">        idef(opcode=<span class="number">0x8000</span>, mask=<span class="number">0xf00f</span>, name=<span class="string">"LD"</span>,   d=self.decode_XY, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VX = VY"</span>),</div><div class="line">        idef(opcode=<span class="number">0x8001</span>, mask=<span class="number">0xf00f</span>, name=<span class="string">"OR"</span>,   d=self.decode_XY, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VX = VX OR VY"</span>),</div><div class="line">        idef(opcode=<span class="number">0x8002</span>, mask=<span class="number">0xf00f</span>, name=<span class="string">"AND"</span>,  d=self.decode_XY, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VX = VX AND VY"</span>),</div><div class="line">        idef(opcode=<span class="number">0x8003</span>, mask=<span class="number">0xf00f</span>, name=<span class="string">"XOR"</span>,  d=self.decode_XY, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VX = VX XOR VY"</span>),</div><div class="line">        idef(opcode=<span class="number">0x8004</span>, mask=<span class="number">0xf00f</span>, name=<span class="string">"ADD"</span>,  d=self.decode_XY, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VX = VX + VY; VF = 1 if overflow else 0"</span>),</div><div class="line">        idef(opcode=<span class="number">0x8005</span>, mask=<span class="number">0xf00f</span>, name=<span class="string">"SUB"</span>,  d=self.decode_XY, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VX = VX - VY; VF = 1 if not borrow else 0"</span>),</div><div class="line">        idef(opcode=<span class="number">0x8006</span>, mask=<span class="number">0xf00f</span>, name=<span class="string">"SHR"</span>,  d=self.decode_XY, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VF = LSB(VX); VX = VX » 1 (** see note)"</span>),</div><div class="line">        idef(opcode=<span class="number">0x8007</span>, mask=<span class="number">0xf00f</span>, name=<span class="string">"SUBN"</span>, d=self.decode_XY, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VX = VY - VX; VF = 1 if not borrow else 0"</span>),</div><div class="line">        idef(opcode=<span class="number">0x800E</span>, mask=<span class="number">0xf00f</span>, name=<span class="string">"SHL"</span>,  d=self.decode_XY, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VF = MSB(VX); VX = VX « 1 (** see note)"</span>),</div><div class="line">        idef(opcode=<span class="number">0x9000</span>, mask=<span class="number">0xf00f</span>, name=<span class="string">"SNE"</span>,  d=self.decode_XY, cf=CF_USE1|CF_USE2|CF_JUMP, cmt=<span class="string">"Skip next instruction if VX != VY"</span>),</div><div class="line">        idef(opcode=<span class="number">0xA000</span>, mask=<span class="number">0xf000</span>, name=<span class="string">"LD"</span>,   d=self.decode_LD_I, cf=CF_USE1, cmt=<span class="string">"I = NNN"</span>),</div><div class="line">        idef(opcode=<span class="number">0xB000</span>, mask=<span class="number">0xf000</span>, name=<span class="string">"JP"</span>,   d=self.decode_JP_V0, cf=CF_USE1|CF_JUMP, cmt=<span class="string">"Jump to address NNN + V0"</span>),</div><div class="line">        idef(opcode=<span class="number">0xC000</span>, mask=<span class="number">0xf000</span>, name=<span class="string">"RND"</span>,  d=self.decode_XY, cf=CF_USE1|CF_CHG1|CF_USE2, cmt=<span class="string">"VX = RND() AND NN"</span>),</div><div class="line">        idef(opcode=<span class="number">0xD000</span>, mask=<span class="number">0xf000</span>, name=<span class="string">"DRW"</span>,  d=self.decode_XYN, cf=CF_USE1|CF_USE2|CF_USE3, cmt=<span class="string">"Draw 8xN sprite at I to VX, VY; VF = 1 if collision else 0"</span>),</div><div class="line">        idef(opcode=<span class="number">0xE09E</span>, mask=<span class="number">0xf0ff</span>, name=<span class="string">"SKP"</span>,  d=self.decode_X, cf=CF_USE1|CF_JUMP, cmt=<span class="string">"Skip next instruction if key(VX) is pressed"</span>),</div><div class="line">        idef(opcode=<span class="number">0xE0A1</span>, mask=<span class="number">0xf0ff</span>, name=<span class="string">"SKNP"</span>, d=self.decode_X, cf=CF_USE1|CF_JUMP, cmt=<span class="string">"Skip next instruction if key(VX) is not pressed"</span>),</div><div class="line">        idef(opcode=<span class="number">0xF007</span>, mask=<span class="number">0xf0ff</span>, name=<span class="string">"LD"</span>,   d=self.decode_LD_VX_DT, cf=CF_USE1|CF_CHG1, cmt=<span class="string">"LD VX, DT;Sets VX to the value of the delay timer."</span>),</div><div class="line">        idef(opcode=<span class="number">0xF00A</span>, mask=<span class="number">0xf0ff</span>, name=<span class="string">"LD"</span>,   d=self.decode_LD_K, cf=CF_USE1|CF_CHG1, cmt=<span class="string">"Wait for key press, store key pressed in VX"</span>),</div><div class="line">        idef(opcode=<span class="number">0xF015</span>, mask=<span class="number">0xf0ff</span>, name=<span class="string">"LD"</span>,   d=self.decode_LD_DT_VX, cf=CF_USE1, cmt=<span class="string">"DT = VX;Sets the delay timer to VX."</span>),</div><div class="line">        idef(opcode=<span class="number">0xF018</span>, mask=<span class="number">0xf0ff</span>, name=<span class="string">"LD"</span>,   d=self.decode_LD_ST, cf=CF_USE1, cmt=<span class="string">"ST = VX;Sets the sound timer to VX."</span>),</div><div class="line">        idef(opcode=<span class="number">0xF01E</span>, mask=<span class="number">0xf0ff</span>, name=<span class="string">"ADD"</span>,  d=self.decode_ADD_I, cf=CF_USE1, cmt=<span class="string">"I = I + VX; VF = 1 if I &gt; 0xFFF else 0"</span>),</div><div class="line">        idef(opcode=<span class="number">0xF029</span>, mask=<span class="number">0xf0ff</span>, name=<span class="string">"LD"</span>,   d=<span class="keyword">None</span>, cf=CF_USE1, cmt=<span class="string">"I = address of 4x5 font character in VX (0..F) (* see note)"</span>),</div><div class="line">        idef(opcode=<span class="number">0xF033</span>, mask=<span class="number">0xf0ff</span>, name=<span class="string">"BCD"</span>,  d=self.decode_X, cf=CF_USE1, cmt=<span class="string">"set_BCD(Vx);*(I+0)=BCD(3);*(I+1)=BCD(2);*(I+2)=BCD(1);Store BCD representation of VX at I (100), I+1 (10), and I+2 (1); I remains unchanged"</span>),</div><div class="line">        idef(opcode=<span class="number">0xF055</span>, mask=<span class="number">0xf0ff</span>, name=<span class="string">"LD"</span>,   d=self.decode_STORE_I, cf=CF_USE1, cmt=<span class="string">"Store V0..VX (inclusive) to memory starting at I; I remains unchanged"</span>),</div><div class="line">        idef(opcode=<span class="number">0xF065</span>, mask=<span class="number">0xf0ff</span>, name=<span class="string">"LD"</span>,   d=self.decode_LOAD_I, cf=CF_USE1, cmt=<span class="string">"Load V0..VX (inclusive) from memory starting at I; I remains unchanged"</span>)</div><div class="line">    ]</div><div class="line">    Instructions = []</div><div class="line">    i = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> self.itable:</div><div class="line">        d = dict(name=x.name, feature=x.cf)</div><div class="line">        <span class="keyword">if</span> x.cmt != <span class="keyword">None</span>:</div><div class="line">            d[<span class="string">'cmt'</span>] = x.cmt</div><div class="line">        Instructions.append(d)</div><div class="line">        setattr(self, <span class="string">'itype_'</span> + (<span class="string">"%04X"</span> % x.opcode), i)</div><div class="line">        i += <span class="number">1</span></div><div class="line">    <span class="comment"># icode of the first instruction</span></div><div class="line">    self.instruc_start = <span class="number">0</span></div><div class="line">    <span class="comment"># icode of the last instruction + 1</span></div><div class="line">    self.instruc_end = len(Instructions) + <span class="number">1</span></div><div class="line">    <span class="comment"># Array of instructions</span></div><div class="line">    self.instruc = Instructions</div><div class="line">    <span class="comment"># Icode of return instruction. It is ok to give any of possible return</span></div><div class="line">    <span class="comment"># instructions</span></div><div class="line">    self.icode_return = self.itype_00EE</div></pre></td></tr></table></figure></p>
<h3 id="实现回调函数"><a href="#实现回调函数" class="headerlink" title="实现回调函数"></a>实现回调函数</h3><h4 id="实现分析与输出"><a href="#实现分析与输出" class="headerlink" title="实现分析与输出"></a>实现分析与输出</h4><p>首先要实现<code>notify_ana(self, insn)</code>，这里因为实现了单独的解析函数并设置好了指令表，直接获取两字节数据与掩码and后查表即可，如果遇到不认识的操作数，<code>return 0</code>告诉ida识别出现了问题。识别正常则返回解析指令及操作数的大小。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_idef</span><span class="params">(self, opcode)</span>:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> self.itable:</div><div class="line">        <span class="keyword">if</span> opcode &amp; i.mask == i.opcode:</div><div class="line">            <span class="keyword">return</span> i</div><div class="line">    <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">notify_ana</span><span class="params">(self, insn)</span>:</span></div><div class="line">      <span class="string">"""</span></div><div class="line">      Decodes an instruction into insn</div><div class="line">      Returns: insn.size (=the size of the decoded instruction) or zero</div><div class="line">      """</div><div class="line">      opcode = insn.get_next_word()</div><div class="line">      ins = self.get_idef(opcode)</div><div class="line">      <span class="keyword">if</span> ins == <span class="keyword">None</span>:</div><div class="line">          <span class="keyword">return</span> <span class="number">0</span></div><div class="line">      <span class="keyword">else</span>:</div><div class="line">          ins.d(insn, opcode)</div><div class="line">      insn.itype = getattr(self,<span class="string">"itype_"</span> + (<span class="string">"%04X"</span> % ins.opcode) )</div><div class="line">       <span class="comment"># Return decoded instruction size or zero</span></div><div class="line">      <span class="keyword">return</span> insn.size</div></pre></td></tr></table></figure></p>
<p>decode系列用于解析操作数的函数大同小异。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_XY</span><span class="params">(self, insn, opcode)</span>:</span></div><div class="line">    insn.Op1.type = o_reg</div><div class="line">    insn.Op1.reg = (opcode &amp; <span class="number">0x0f00</span>)&gt;&gt;<span class="number">8</span></div><div class="line">    insn.Op2.type = o_reg</div><div class="line">    insn.Op2.reg = (opcode &amp; <span class="number">0x00f0</span>)&gt;&gt;<span class="number">4</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_NNN_mem</span><span class="params">(self, insn, opcode)</span>:</span></div><div class="line">    insn.Op1.type = o_near</div><div class="line">    insn.Op1.dtype = dt_word</div><div class="line">    insn.Op1.addr = opcode &amp; <span class="number">0xfff</span></div><div class="line"></div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>然后实现<code>notify_out_operand(self, ctx, op)</code>与<code>notify_out_insn(self, ctx)</code>两个方法，一个负责输出操作数，一个负责输出指令。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">notify_out_insn</span><span class="params">(self, ctx)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Generate text representation of an instruction in 'ctx.insn' structure.</div><div class="line">    This function shouldn't change the database, flags or anything else.</div><div class="line">    All these actions should be performed only by u_emu() function.</div><div class="line">    Returns: nothing</div><div class="line">    """</div><div class="line">    ctx.out_mnemonic()</div><div class="line">    ctx.out_one_operand(<span class="number">0</span>)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">4</span>):</div><div class="line">            op = ctx.insn[i]</div><div class="line">            <span class="keyword">if</span> op.type == o_void:</div><div class="line">                    <span class="keyword">break</span></div><div class="line">            ctx.out_symbol(<span class="string">','</span>)</div><div class="line">            ctx.out_char(<span class="string">' '</span>)</div><div class="line">            ctx.out_one_operand(i)</div><div class="line">    ctx.set_gen_cmt()</div><div class="line">    ctx.flush_outbuf()</div></pre></td></tr></table></figure></p>
<p>在notify_out_insn中调用ctx.out_mnemonic来输出instruc中指令的name。之后调用ctx.out_one_operand(i)输出操作数，此方法会调用到下面的<code>notify_out_operand(self, ctx, op)</code>回调来输出操作数信息。其中op参数会携带指令操作数信息，在分析时可以设置specval属性来携带额外信息给输出方法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">notify_out_operand</span><span class="params">(self, ctx, op)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Generate text representation of an instructon operand.</div><div class="line">    This function shouldn't change the database, flags or anything else.</div><div class="line">    All these actions should be performed only by u_emu() function.</div><div class="line">    The output text is placed in the output buffer initialized with init_output_buffer()</div><div class="line">    This function uses out_...() functions from ua.hpp to generate the operand text</div><div class="line">    Returns: 1-ok, 0-operand is hidden.</div><div class="line">    """</div><div class="line">    optype = op.type</div><div class="line">    fl     = op.specval</div><div class="line">    <span class="keyword">if</span> optype == o_reg:</div><div class="line">        ctx.out_register(self.reg_names[op.reg])</div><div class="line">    <span class="keyword">elif</span> optype == o_imm:</div><div class="line">        <span class="comment"># for immediate loads, use the transfer width (type of first operand)</span></div><div class="line">        <span class="comment"># if op.n == 1:</span></div><div class="line">        <span class="comment">#     width = self.dt_to_width(ctx.insn.Op1.dtype)</span></div><div class="line">        <span class="comment"># else:</span></div><div class="line">        <span class="comment">#     width = OOFW_32 if self.PTRSZ == 4 else OOFW_64</span></div><div class="line">        ctx.out_value(op,<span class="number">8</span>)</div><div class="line">    <span class="keyword">elif</span> optype <span class="keyword">in</span> [o_near, o_mem]:</div><div class="line">        r = ctx.out_name_expr(op, op.addr, BADADDR)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> r:</div><div class="line">            ctx.out_tagon(COLOR_ERROR)</div><div class="line">            ctx.out_btoa(op.addr, <span class="number">4</span>)</div><div class="line">            ctx.out_tagoff(COLOR_ERROR)</div><div class="line">            remember_problem(PR_NONAME, ctx.insn.ea)</div><div class="line">    <span class="keyword">elif</span> optype == o_displ:</div><div class="line">        <span class="keyword">if</span> fl &amp; self.FL_K == self.FL_K:</div><div class="line">            ctx.out_symbol(<span class="string">'['</span>)</div><div class="line">            ctx.out_char(<span class="string">'K'</span>)</div><div class="line">            ctx.out_symbol(<span class="string">']'</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            ctx.out_symbol(<span class="string">'['</span>)</div><div class="line">            ctx.out_register(self.reg_names[op.reg])</div><div class="line">            ctx.out_symbol(<span class="string">']'</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<p>到这里已经可以使用这个处理器模块了，将其放置在ida目录的procs下。加载文件时选择处理器类型CHIP-8。在想要反汇编的地方c来make_code，成功。但是会发现按一下c只识别一个，指令之间没有联系，更别提跳转了。如下图<br><img src="http://pic.leommxj.com//blog/write-a-ida-process-module-for-chip-8/without_emu.png" alt="without_emu"><br>这就是因为没有实现notify_emu方法，指令解析完后没有互相的引用导致的。下面来实现模拟部分。</p>
<h4 id="实现模拟"><a href="#实现模拟" class="headerlink" title="实现模拟"></a>实现模拟</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">notify_emu</span><span class="params">(self, insn)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Emulate instruction, create cross-references, plan to analyze</div><div class="line">    subsequent instructions, modify flags etc. Upon entrance to this function</div><div class="line">    all information about the instruction is in 'insn' structure.</div><div class="line">    If zero is returned, the kernel will delete the instruction.</div><div class="line">    """</div><div class="line">    feature = insn.get_canon_feature()</div><div class="line">    flow = (feature &amp; CF_STOP) == <span class="number">0</span></div><div class="line">    <span class="keyword">if</span> feature &amp; CF_JUMP:</div><div class="line">        remember_problem(PR_JUMP, insn.ea)</div><div class="line">    <span class="keyword">if</span> insn.itype == self.itype_1000:</div><div class="line">        add_cref(insn.ea, insn.Op1.addr, fl_JN)</div><div class="line">        flow = <span class="keyword">False</span></div><div class="line">    <span class="keyword">elif</span> insn.itype == self.itype_2000:</div><div class="line">        add_cref(insn.ea, insn.Op1.addr, fl_CN)</div><div class="line">    <span class="keyword">elif</span> insn.itype <span class="keyword">in</span> (self.itype_3000, self.itype_4000, self.itype_5000, self.itype_9000):</div><div class="line">        add_cref(insn.ea, insn.ea + insn.size*<span class="number">2</span>, fl_JN)</div><div class="line">    <span class="keyword">if</span> flow:</div><div class="line">        add_cref(insn.ea, insn.ea + insn.size, fl_F)</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span></div></pre></td></tr></table></figure>
<p>JP与CALL指令根据操作数来设置引用地址。所有JP、CALL以及RET指令在定义itable的时候feature都设置了CF_STOP标志位，其不引用相邻指令，除此之外指令对相邻指令添加引用。<br>简单实现emu之后再用ida载入，设置加载地址为0x200(见CHIP8简介)。直接按p定义函数，效果如下图(载入的rom文件:<a href="https://github.com/massung/CHIP-8/raw/master/games/roms/BLITZ" target="_blank" rel="external">BLITZ</a>)<br><img src="http://pic.leommxj.com//blog/write-a-ida-process-module-for-chip-8/with_emu.png" alt="with_emu"></p>
<h2 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h2><p>实现了一个非常简单的指令集的处理器模块，关于trace_sp，switch等均未涉及到，算是对idp有一个简单的了解和实践，完整代码:<a href="https://gist.github.com/leommxj/1e637ba070e54de3bea5854f1af51f7d" target="_blank" rel="external">chip8.py</a>。珠玉在前，下面给出一些过程中参考的优秀的文章，感谢大佬们的指点。</p>
<ul>
<li><a href="https://blog.quarkslab.com/ida-processor-module.html" target="_blank" rel="external">IDA processor module - Kevin Szkudlapski</a></li>
<li><a href="http://www.hexblog.com/?p=116" target="_blank" rel="external">Scriptable Processor modules - Hex Blog</a></li>
<li><a href="https://www.anquanke.com/post/id/153699" target="_blank" rel="external">Lua程序逆向之为Luac编写IDA Pro处理器模块 - 非虫</a></li>
<li><a href="https://blog.delroth.net/2011/11/random-thoughts-about-writing-an-ida-processor-module/" target="_blank" rel="external">Random thoughts about writing an IDA processor module - delroth</a></li>
<li><a href="http://wuffs.org/blog/mouse-adventures-part-7" target="_blank" rel="external">Mouse Adventures #7: Writing an IDA Processor Module - Ash Wolf</a></li>
</ul>
<p>首发于安全客：<a href="https://www.anquanke.com/post/id/172217" target="_blank" rel="external">https://www.anquanke.com/post/id/172217</a> </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/02/2018HITCTF-WriteUp/" itemprop="url">
                  2018HITCTF-WriteUp
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-02-02T19:58:50+08:00" content="2018-02-02">
              2018-02-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Sec/" itemprop="url" rel="index">
                    <span itemprop="name">Sec</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Sec/Writeup/" itemprop="url" rel="index">
                    <span itemprop="name">Writeup</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>哈工大的校赛，抽了两个下午打了几个小时，还是菜了2333。记录一下。<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2018/02/02/2018HITCTF-WriteUp/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/30/CTFd-deployment-using-Nginx-Tornado/" itemprop="url">
                  Nginx+Tornado部署CTFd
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-01-30T17:34:09+08:00" content="2018-01-30">
              2018-01-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Operations/" itemprop="url" rel="index">
                    <span itemprop="name">Operations</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>假期要做点简单的培训需要一个平台放题,在考虑再三后还是选择了<a href="https://github.com/CTFd/CTFd">CTFd</a> .部署没有采用官方推荐的<a href="http://gunicorn.org/">gunicorn</a>而用了<a href="http://www.tornadoweb.org">tornado</a>,为了利用多核性能前面加了Nginx做反向代理,其后运行四个Tornado实例。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2018/01/30/CTFd-deployment-using-Nginx-Tornado/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/17/Car-Hacking-101-智能汽车攻防/" itemprop="url">
                  Car Hacking 101/智能汽车攻防
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-12-17T23:46:52+08:00" content="2017-12-17">
              2017-12-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Sec/" itemprop="url" rel="index">
                    <span itemprop="name">Sec</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>智能汽车攻防，(除去对PKE、RKE等的hacking只考虑控制车身系统)个人认为可以分为两个阶段。第一阶段是寻找如何接入CAN总线，第二阶段是CAN总线上的数据分析与攻击。第一阶段的研究基本要靠车型本身信息系统的漏洞，比如未将多媒体系统与舒适can隔离，条件所限难以研究。第二阶段上手较为简单，本文主要集中在第二阶段。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/12/17/Car-Hacking-101-智能汽车攻防/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/24/2017-11-24-Openstack-pike-Installation/" itemprop="url">
                  OpenStack pike 单节点部署测试和踩坑
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-11-24T13:08:28+08:00" content="2017-11-24">
              2017-11-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Operations/" itemprop="url" rel="index">
                    <span itemprop="name">Operations</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>Centos7.3 OpenStack pike版本单节点部署，只安装了glance、keystone、nova、neutron和horizon没有部署cinder swift等。过程主要是跟官方文档走，过程中有几个坑点，记录一下。<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/11/24/2017-11-24-Openstack-pike-Installation/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/02/2017XDCTF-Writeup/" itemprop="url">
                  2017XDCTF-Writeup
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-02T21:30:00+08:00" content="2017-10-02">
              2017-10-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Sec/" itemprop="url" rel="index">
                    <span itemprop="name">Sec</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Sec/Writeup/" itemprop="url" rel="index">
                    <span itemprop="name">Writeup</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>大国庆的，做着做着就不想做了，假装自己是一个战队。<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/10/02/2017XDCTF-Writeup/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/11/RCE-Bypass/" itemprop="url">
                  RCE Bypass 远程命令执行绕过技巧
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-06-11T14:57:24+08:00" content="2017-06-11">
              2017-06-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Sec/" itemprop="url" rel="index">
                    <span itemprop="name">Sec</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>最近在几个ctf比赛中遇到好几次远程命令执行绕过的题，网上资料比较零散，做一下整理。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/06/11/RCE-Bypass/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/08/AlexCTF-Writeup/" itemprop="url">
                  AlexCTF-Writeup
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-08T16:44:08+08:00" content="2017-02-08">
              2017-02-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Sec/" itemprop="url" rel="index">
                    <span itemprop="name">Sec</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Sec/Writeup/" itemprop="url" rel="index">
                    <span itemprop="name">Writeup</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>一个由埃及亚历山大大学的学生俱乐部<a href="https://twitter.com/MSTCAlex">MSP Teach Club</a>组织的CTF比赛,办得不错。第一次参加外国的CTF比赛，感觉出题的有些思路跟国内真是不一样。由于运维难度比赛主办没出PWN和WEB的题:D.最后还是有几道题没做出来，看各种大神全做完也是很心累。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/02/08/AlexCTF-Writeup/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/08/hello-world/" itemprop="url">
                  hello_world
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-08T16:44:00+08:00" content="2017-02-08">
              2017-02-08
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python -c <span class="string">"print '略略略略'"</span></div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/avatar.jpg"
               alt="leommxj" />
          <p class="site-author-name" itemprop="name">leommxj</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">9</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/leommxj" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">leommxj</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  


  

    
      
    

   
  
  
  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
